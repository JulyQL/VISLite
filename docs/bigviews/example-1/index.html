<div class="view" id="root">

    <!-- 旋转球 -->
    <div class="global-view" id="global-view">
        <div class="global-line"></div>
        <div class="global-rt"></div>
    </div>

    <!-- 大标题 -->
    <div class="title-view">
        <div class="title">
            数据可视化大屏
        </div>
    </div>

    <!-- 地图 -->
    <div class="view-map" id="view_map"></div>

    <!-- 左上 -->
    <div class="view-item left top" id="view_left_top"></div>

    <!-- 左中 -->
    <div class="view-item left middle" id="view_left_middle"></div>

    <!-- 左下 -->
    <div class="view-item left bottom" id="view_left_bottom"></div>

    <!-- 右上 -->
    <div class="view-item right top" id="view_right_top"></div>

    <!-- 右中 -->
    <div class="view-item right middle" id="view_right_middle"></div>

    <!-- 右下 -->
    <div class="view-item right bottom" id="view_right_bottom"></div>

</div>
<script type="module">
    import { Canvas, throttle, Mercator } from "vislite";

    fetch('./data/china.json').then(function (res) {
        if (res.status === 200) {
            return res.json();
        }
    }).then(function (res) {

        // 绘制地图
        var updateView, mapPainter;
        var drawMap = function (painter) {
            mapPainter = painter;

            var info = painter.getInfo();
            var width = info.width;
            var height = info.height;

            var mercator = new Mercator(Math.min(width * 0.01, height * 0.016)), cx = width * 0.54, cy = height * 0.5;

            var t, p, i, j, k;

            var drawPolygon = function (data, dx, dy) {
                for (t = 0; t < data.length; t++) {
                    painter.beginPath();
                    for (p = 0; p < data[t].length; p++) {
                        var point = mercator.use(data[t][p][0], data[t][p][1]);
                        painter.lineTo(point[0] + cx + dx, point[1] + cy + dy);
                    }
                    painter.closePath().full();
                }
            };

            var drawRegion = function (feature, dx, dy) {
                painter.setRegion(feature.properties.name);

                console.log(feature.properties)

                for (j = 0; j < feature.geometry.coordinates.length; j++) {
                    if (feature.geometry.type == "Polygon") {
                        drawPolygon(feature.geometry.coordinates, dx, dy);
                    } else {
                        for (k = 0; k < feature.geometry.coordinates.length; k++) {
                            drawPolygon(feature.geometry.coordinates[k], dx, dy);
                        }
                    }
                }
            };

            var gradient = painter.createLinearGradient(0, 0, 0, height).setColor(0.2, "#030783").setColor(0.5, "#193399").setColor(0.8, "#030783");
            updateView = function (regionName) {
                painter.clearRect(0, 0, width, height);

                painter.config({
                    fillStyle: "#02185b",
                    strokeStyle: '#02185b',
                });

                for (i = 0; i < res.features.length; i++) {
                    drawRegion(res.features[i], 5, 20);
                }

                painter.config({
                    fillStyle: gradient.value(),
                    strokeStyle: '#273da6',
                    lineWidth: 1
                });

                var currentIndex = -1;
                for (i = 0; i < res.features.length; i++) {
                    if (res.features[i].properties.name == regionName) {
                        currentIndex = i;
                    } else {
                        drawRegion(res.features[i], 0, 0);
                    }
                }

                if (currentIndex != -1) {
                    painter.config({
                        fillStyle: '#030783'
                    });
                    drawRegion(res.features[currentIndex], 0, 0);
                }

            };

            updateView();
        };

        var preRegionName;
        var mycontent = document.getElementById('view_map');
        mycontent.addEventListener("mousemove", function (event) {
            if (updateView) {
                mapPainter.getRegion(event.offsetX, event.offsetY).then((regionName) => {
                    if (preRegionName != regionName) {
                        preRegionName = regionName;

                        mycontent.setAttribute('title', regionName);
                        updateView(regionName);
                    }
                });
            }
        });

        // 绘制边框
        var drawBoxBorder = function (painter) {
            var info = painter.getInfo();

            painter.config({
                lineWidth: 4,
                strokeStyle: "rgb(33,150,243)"
            })
                .beginPath().moveTo(2, 20).lineTo(2, 2).lineTo(20, 2).stroke()
                .beginPath().moveTo(info.width - 20, 2).lineTo(info.width - 2, 2).lineTo(info.width - 2, 20).stroke()
                .beginPath().moveTo(2, info.height - 20).lineTo(2, info.height - 2).lineTo(20, info.height - 2).stroke()
                .beginPath().moveTo(info.width - 20, info.height - 2).lineTo(info.width - 2, info.height - 2).lineTo(info.width - 2, info.height - 20).stroke();
        };

        var updateSize = function () {
            var width = 1920;
            var height = 1920 * window.innerHeight / window.innerWidth;

            window.scaleVal = window.innerWidth / 1920;

            var rootEl = document.getElementById('root');
            rootEl.style.transformOrigin = 'left top';
            rootEl.style.transform = 'scale(' + window.scaleVal + ',' + window.scaleVal + ' )';
            rootEl.style.width = width + "px";
            rootEl.style.height = height + 'px';

            // 球
            var globalViewEl = document.getElementById("global-view"), globalSize = height * 0.8;
            globalViewEl.style.width = globalSize + "px";
            globalViewEl.style.height = globalSize + "px";
            globalViewEl.style.left = "calc(50% - " + globalSize * 0.5 + "px)";
            globalViewEl.style.top = (height * 0.545 - globalSize * 0.5) + "px";

            // 左上
            var painterLT = new Canvas(document.getElementById('view_left_top'));
            drawBoxBorder(painterLT);

            // 左中
            var painterLM = new Canvas(document.getElementById('view_left_middle'));
            drawBoxBorder(painterLM);

            // 左下
            var painterLB = new Canvas(document.getElementById('view_left_bottom'));
            drawBoxBorder(painterLB);

            // 右上
            var painterRT = new Canvas(document.getElementById('view_right_top'));
            drawBoxBorder(painterRT);

            // 右中
            var painterRM = new Canvas(document.getElementById('view_right_middle'));
            drawBoxBorder(painterRM);

            // 右下
            var painterRB = new Canvas(document.getElementById('view_right_bottom'));
            drawBoxBorder(painterRB);

            // 地图
            var painterMap = new Canvas(document.getElementById('view_map'));
            drawMap(painterMap);

        };
        window.addEventListener("resize", throttle(updateSize));

        updateSize();
    });
</script>
<style>
    /* 旋转 */
    @keyframes rotateView {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    body {
        margin: 0;
        height: 100vh;
        width: 100vw;
        overflow-x: hidden;
        overflow-y: hidden;
        font-family: fangsong;
    }

    #root {
        background-image: url("./bigviews/example-1/images/bg.jpeg");
        background-size: cover;
        background-position: center center;
        position: relative;
    }

    /* 球 */
    .global-view {
        width: 600px;
        height: 600px;
        position: absolute;
        left: calc(50% - 300px);
        top: 25%;
        background-image: url("./bigviews/example-1/images/global-circle.png");
        background-size: 100% auto;
    }

    .global-view>div {
        width: inherit;
        height: inherit;
        position: absolute;
        background-size: 100% auto;
    }

    .global-view .global-rt {
        background-image: url("./bigviews/example-1/images/global-rt.png");
        animation-duration: 15s;
        animation-iteration-count: infinite;
        animation-name: rotateView;
        animation-timing-function: linear;
        animation-direction: reverse;
    }

    .global-view .global-line {
        background-image: url("./bigviews/example-1/images/global-line.png");
        animation-duration: 20s;
        animation-iteration-count: infinite;
        animation-name: rotateView;
        animation-timing-function: linear;
    }

    /* 大标题 */
    .title-view {
        position: absolute;
        left: 0%;
        top: 0%;
        width: 100%;
        height: 9%;
        background-image: url("./bigviews/example-1/images/head_bg.png");
        background-size: auto 100%;
        background-repeat: no-repeat;
        background-position: center -10px;
    }

    .title-view>.title {
        font-size: 35px;
        color: white;
        text-align: center;
        line-height: 40px;
        position: relative;
        top: calc(50% - 20px);
        font-weight: 800;
    }

    /* 小图表 */
    .view-item {
        position: absolute;
        width: 22%;
        height: 29%;
        background-color: rgb(146 199 225 / 9%);
    }

    .view-item.left {
        left: 1%;
    }

    .view-item.right {
        left: 77%;
    }

    .view-item.top {
        top: 8%;
    }

    .view-item.middle {
        top: 39%;
    }

    .view-item.bottom {
        top: 70%;
    }

    /* 地图 */
    .view-map {
        position: absolute;
        left: 20%;
        top: 6%;
        width: 60%;
        height: 93%;
    }
</style>