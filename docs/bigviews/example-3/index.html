<div class="view" id="root">

    <!-- 大标题 -->
    <div class="title-view">
        <div class="bg"></div>
        <div class="title">
            数据可视化大屏
        </div>
    </div>

    <!-- 地图 -->
    <div class="view-map" id="view_map"></div>

    <!-- 左上 -->
    <div class="view-item left top">
        <div class="title">
            <span></span>
        </div>
        <div id="view_left_top" class="content"></div>
    </div>

    <!-- 左中 -->
    <div class="view-item left middle">
        <div class="title">
            <span></span>
        </div>
        <div id="view_left_middle" class="content"></div>
    </div>

    <!-- 左下 -->
    <div class="view-item left bottom">
        <div class="title">
            <span></span>
        </div>
        <div id="view_left_bottom" class="content"></div>
    </div>

    <!-- 右上 -->
    <div class="view-item right top">
        <div class="title">
            <span></span>
        </div>
        <div id="view_right_top" class="content"></div>
    </div>

    <!-- 右中 -->
    <div class="view-item right middle">
        <div class="title">
            <span></span>
        </div>
        <div id="view_right_middle" class="content"></div>
    </div>

    <!-- 右下 -->
    <div class="view-item right bottom">
        <div class="title">
            <span></span>
        </div>
        <div id="view_right_bottom" class="content"></div>
    </div>

    <!-- 中间 -->
    <div class="view-item center bottom">
        <div class="title">
            <span></span>
        </div>
        <div id="view_center_bottom" class="content"></div>
    </div>

</div>
<script type="module">
    import { Canvas, throttle, Mercator } from "vislite";

    fetch('./data/china.json').then(function (res) {
        if (res.status === 200) {
            return res.json();
        }
    }).then(function (res) {

        // 绘制地图
        var updateView, mapPainter;
        var drawMap = function (painter) {
            mapPainter = painter;

            var info = painter.getInfo();
            var width = info.width;
            var height = info.height;

            var mercator = new Mercator(Math.min(width * 0.01, height * 0.016)), cx = width * 0.54, cy = height * 0.5;

            var t, p, i, j, k;

            var drawPolygon = function (data, dx, dy) {
                for (t = 0; t < data.length; t++) {
                    painter.beginPath();
                    for (p = 0; p < data[t].length; p++) {
                        var point = mercator.use(data[t][p][0], data[t][p][1]);
                        painter.lineTo(point[0] + cx + dx, point[1] + cy + dy);
                    }
                    painter.closePath().full();
                }
            };

            var drawRegion = function (feature, dx, dy) {
                painter.setRegion(feature.properties.name);

                console.log(feature.properties)

                for (j = 0; j < feature.geometry.coordinates.length; j++) {
                    if (feature.geometry.type == "Polygon") {
                        drawPolygon(feature.geometry.coordinates, dx, dy);
                    } else {
                        for (k = 0; k < feature.geometry.coordinates.length; k++) {
                            drawPolygon(feature.geometry.coordinates[k], dx, dy);
                        }
                    }
                }
            };

            updateView = function (regionName) {
                painter.clearRect(0, 0, width, height);

                painter.config({
                    fillStyle: "#062848",
                    strokeStyle: '#134574',
                    lineWidth: 1
                });

                var currentIndex = -1;
                for (i = 0; i < res.features.length; i++) {
                    if (res.features[i].properties.name == regionName) {
                        currentIndex = i;
                    } else {
                        drawRegion(res.features[i], 0, 0);
                    }
                }

                if (currentIndex != -1) {
                    painter.config({
                        fillStyle: '#FF9800'
                    });
                    drawRegion(res.features[currentIndex], 0, 0);
                }

            };

            updateView();
        };

        var preRegionName;
        var mycontent = document.getElementById('view_map');
        mycontent.addEventListener("mousemove", function (event) {
            if (updateView) {
                mapPainter.getRegion(event.offsetX, event.offsetY).then((regionName) => {
                    if (preRegionName != regionName) {
                        preRegionName = regionName;

                        mycontent.setAttribute('title', regionName);
                        updateView(regionName);
                    }
                });
            }
        });

        var updateSize = function () {
            var width = 1920;
            var height = 1920 * window.innerHeight / window.innerWidth;

            window.scaleVal = window.innerWidth / 1920;

            var rootEl = document.getElementById('root');
            rootEl.style.transformOrigin = 'left top';
            rootEl.style.transform = 'scale(' + window.scaleVal + ',' + window.scaleVal + ' )';
            rootEl.style.width = width + "px";
            rootEl.style.height = height + 'px';

            // 左上
            var painterLT = new Canvas(document.getElementById('view_left_top'));

            // 左中
            var painterLM = new Canvas(document.getElementById('view_left_middle'));

            // 左下
            var painterLB = new Canvas(document.getElementById('view_left_bottom'));

            // 右上
            var painterRT = new Canvas(document.getElementById('view_right_top'));

            // 右中
            var painterRM = new Canvas(document.getElementById('view_right_middle'));

            // 右下
            var painterRB = new Canvas(document.getElementById('view_right_bottom'));

            // 右下
            var painterRB = new Canvas(document.getElementById('view_right_bottom'));

            // 中下
            var painterCB = new Canvas(document.getElementById('view_center_bottom'));


            // 地图
            var painterMap = new Canvas(document.getElementById('view_map'));
            drawMap(painterMap);

        };
        window.addEventListener("resize", throttle(updateSize));

        updateSize();

    });
</script>
<style>
    body {
        margin: 0;
        height: 100vh;
        width: 100vw;
        overflow-x: hidden;
        overflow-y: hidden;
        font-family: fangsong;
    }

    #root {
        background-image: url("./bigviews/example-3/images/bg.jpg");
        background-size: cover;
        background-position: center center;
        position: relative;
    }

    .title-view {
        position: absolute;
        left: 0%;
        top: 0%;
        width: 100%;
        height: 9%;
        background-image: url("./bigviews/example-3/images/head_bg.png");
        background-size: auto 100%;
        background-repeat: no-repeat;
        background-position: center top;
    }

    .title-view>.title {
        font-size: 30px;
        color: white;
        text-align: center;
        line-height: 40px;
        position: relative;
        top: calc(50% - 20px);
        font-weight: 800;
    }

    /* 小图表 */
    .view-item {
        position: absolute;
        width: 22%;
        height: calc(29% - 10px);
        box-shadow: -10px 0px 15px #062848 inset, 0px -10px 15px #062848 inset, 10px 0px 15px #062848 inset, 0px 10px 15px #062848 inset;
        border: 1px solid #062848;
    }

    .view-item>.content {
        height: 100%;
    }

    .view-item>.title {
        position: absolute;
        text-align: center;
        top: -20px;
        width: 100%;
    }

    .view-item>.title>span {
        background-color: #062848;
        border-radius: 20px;
        display: inline-block;
        height: 40px;
        color: #ffffff;
        font-weight: bold;
        font-size: 16px;
        line-height: 40px;
        padding: 0 15px;
        min-width: 200px;
    }

    .view-item.left {
        left: 1%;
    }

    .view-item.right {
        left: 77%;
    }

    .view-item.top {
        top: 8%;
    }

    .view-item.middle {
        top: 39%;
    }

    .view-item.bottom {
        top: 70%;
    }

    .view-item.center {
        left: 24%;
        width: 52%;
    }

    /* 地图 */
    .view-map {
        position: absolute;
        left: 20%;
        top: 8%;
        width: 60%;
        height: 60%;
    }
</style>